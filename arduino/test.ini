const int PWM_PIN = 4;
const int ENABLE_PIN = 5;
const int DIRECTION_PIN = 6;
const int MAX_PWM = 255;

const int READ_PIN1 = A2;
const int READ_PIN2 = A3;

void setup() {
  Serial.begin(9600);
  pinMode(PWM_PIN, OUTPUT);
  pinMode(ENABLE_PIN, OUTPUT);
  pinMode(DIRECTION_PIN, OUTPUT);
}

void loop() {
  if (Serial.available()) {
    String read = Serial.readString();
    if (read == "READ") {
      Serial.println((String) analogRead(READ_PIN1) + " " + (String) analogRead(READ_PIN2));
    } else {
      int idx = read.indexOf(' ');
      int leftPWM, rightPWM;
      if (idx == -1) {
        leftPWM = read.toInt();
        rightPWM = read.toInt();
      } else {
        String read1 = read.substring(0, idx);
        String read2 = read.substring(idx + 1);
        leftPWM = read1.toInt();
        rightPWM = read2.toInt();
      }
      // Normalize to 0 - 255
      bool leftNeg = false, rightNeg = false;
      if (leftPWM < 0) {
        leftNeg = true;
        leftPWM *= -1;
      }
      if (rightPWM < 0) {
        rightNeg = true;
        rightPWM *= -1;
      }
      leftPWM = min(leftPWM, MAX_PWM);
      rightPWM = min(rightPWM, MAX_PWM);
      analogWrite(PWM_PIN, leftPWM);
      if (leftPWM == 0 && rightPWM == 0) {
        digitalWrite(ENABLE_PIN, LOW);
      } else {
        digitalWrite(ENABLE_PIN, HIGH);
      }
      if (leftNeg) {
        leftPWM *= -1;
        digitalWrite(DIRECTION_PIN, LOW);
      } else {
        digitalWrite(DIRECTION_PIN, HIGH);
      }
      if (rightNeg) {
        rightPWM *= -1;
      }
      Serial.println((String) leftPWM + " " + (String) rightPWM);
    }
    Serial.println();
    Serial.flush();
  }
}
